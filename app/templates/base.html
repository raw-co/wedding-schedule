<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ title or "Wedding Schedule App" }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/app.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg bg-light border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">스케줄</a>
    <div class="ms-auto d-flex gap-2 align-items-center">
      {% if user %}
        <span class="text-muted small">{{ user.name }}{% if user.is_admin %} (관리자){% endif %}</span>
        <form method="post" action="/logout" class="m-0">
          <button class="btn btn-outline-secondary btn-sm">로그아웃</button>
        </form>
      {% endif %}
    </div>
  </div>
</nav>
<main class="container my-4">
  {% block content %}{% endblock %}
</main>

<!-- Toast container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
  <div id="alertToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">지연 알림</strong>
      <small id="alertToastTime" class="text-muted">방금</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="alertToastBody">
      지연 알림이 있습니다.
    </div>
  </div>
</div>

<script>
(function() {
  function isAdminPage() {
    return window.location.pathname.startsWith("/admin");
  }
  function showToast(message) {
    const body = document.getElementById("alertToastBody");
    const time = document.getElementById("alertToastTime");
    if (!body) return;
    body.textContent = message;
    if (time) time.textContent = new Date().toLocaleTimeString();
    const toastEl = document.getElementById("alertToast");
    if (toastEl && window.bootstrap) {
      const t = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 8000 });
      t.show();
    }
  }
  async function poll() {
    if (!isAdminPage()) return;
    try {
      const res = await fetch("/admin/alerts/feed", { headers: { "Accept": "application/json" }});
      const data = await res.json();
      if (!data.ok) return;

      const lastSeen = JSON.parse(localStorage.getItem("seen_alert_keys") || "[]");
      const seenSet = new Set(lastSeen);

      const keys = (data.alerts || []).map(a => a.key);
      const newAlerts = (data.alerts || []).filter(a => !seenSet.has(a.key));

      if (newAlerts.length > 0) {
        const a = newAlerts[0];
        const parts = [];
        if (a.wake_overdue) parts.push("기상 지연");
        if (a.depart_overdue) parts.push("출발 지연");
        if (a.arrive_overdue) parts.push("도착 지연");
        showToast(`${a.date} ${a.venue} - ${a.name}(${a.role}) : ${parts.join(", ")}`);
      }

      localStorage.setItem("seen_alert_keys", JSON.stringify(keys));
      localStorage.setItem("seen_alert_keys_ts", String(Date.now()));

      if (typeof data.count === "number") {
        document.title = (data.count > 0 ? `(${data.count}) ` : "") + document.title.replace(/^\(\d+\)\s*/, "");
      }
    } catch (e) {}
  }

  const ts = parseInt(localStorage.getItem("seen_alert_keys_ts") || "0", 10);
  if (ts && (Date.now() - ts) > 60*60*1000) {
    localStorage.removeItem("seen_alert_keys");
    localStorage.removeItem("seen_alert_keys_ts");
  }

  poll();
  setInterval(poll, 60 * 1000);
})();
</script>

</body>
</html>
